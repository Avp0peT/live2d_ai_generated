<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Live2D Pixi é¢„è§ˆ</title>
    <style>
      html, body { height: 100%; margin: 0; background: #0f1115; color: #eaeef2; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
      #toolbar { padding: 12px; background: #151922; position: sticky; top: 0; z-index: 1; display: flex; gap: 8px; align-items: center; }
      input, button { background: #1c2230; color: #eaeef2; border: 1px solid #2a3245; padding: 6px 8px; border-radius: 6px; }
      button { cursor: pointer; }
      #stage { width: 100%; height: calc(100% - 56px); }
    </style>
    <!-- é™æ€å¼•ç”¨ï¼ˆå¯èƒ½è¢«æ‹¦æˆªï¼Œä¸‹é¢çš„åŠ¨æ€åŠ è½½ä¼šå…œåº•ï¼‰ -->
    <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@7/dist/browser/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@3/dist/index.min.js"></script>
  </head>
  <body>
    <div id="toolbar">
      <label>æ¨¡åž‹ç›®å½•: <input type="text" id="modelDir" placeholder="outputs/ai_full_all_001" size="36" /></label>
      <button id="loadBtn">åŠ è½½</button>
      <label>AngleX: <input type="range" id="angleX" min="-30" max="30" step="1" value="0" /></label>
      <label>EyeBlink: <input type="range" id="blink" min="0" max="1" step="0.05" value="1" /></label>
      <button id="exprSmile">è¡¨æƒ…: Smile</button>
      <button id="exprNeutral">è¡¨æƒ…: Neutral</button>
      <label>åŠ¨ä½œ: <select id="motionSelect"></select></label>
      <button id="playMotion">æ’­æ”¾</button>
      <span id="status"></span>
    </div>
    <div id="stage"></div>
    <script>
      // æ·»åŠ  process polyfill ä»¥è§£å†³ pixi-live2d-display çš„å…¼å®¹æ€§é—®é¢˜
      if (typeof process === 'undefined') {
        window.process = {
          env: {},
          nextTick: function(fn) { setTimeout(fn, 0); },
          version: 'v16.0.0'
        };
      }
      
      let app = null;
      async function loadScript(url){
        return new Promise((resolve, reject)=>{
          const s = document.createElement('script');
          s.src = url; s.async = true; s.onload = ()=>resolve(url); s.onerror = ()=>reject(new Error('load fail '+url));
          document.head.appendChild(s);
        });
      }
      async function tryLoad(urls){
        for(const u of urls){
          try{ 
            console.log(`ðŸ”„ å°è¯•åŠ è½½: ${u}`);
            await loadScript(u); 
            console.log(`âœ… æˆåŠŸåŠ è½½: ${u}`);
            return u; 
          }catch(e){ 
            console.warn(`âŒ åŠ è½½å¤±è´¥: ${u}`, e.message); 
          }
        }
        throw new Error('All CDNs failed for '+urls[0]);
      }
      async function ensureDeps(){
        console.log('ðŸ”§ å¼€å§‹åŠ è½½ä¾èµ–...');
        
        // Cubism Coreï¼ˆä¼˜å…ˆå·²æœ‰ï¼Œå¦åˆ™å°è¯•å†æ¬¡åŠ è½½ï¼‰
        if(!window.Live2DCubismCore){
          console.log('ðŸ“¦ åŠ è½½ Cubism Core...');
          await tryLoad([
            '/web/lib/live2dcubismcore.min.js',
            'https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js'
          ]);
        } else {
          console.log('âœ… Cubism Core å·²å­˜åœ¨');
        }
        
        // PIXI
        if(!window.PIXI){
          console.log('ðŸŽ® åŠ è½½ PIXI...');
          await tryLoad([
            '/web/lib/pixi.min.js',
            'https://cdn.jsdelivr.net/npm/pixi.js@7/dist/browser/pixi.min.js',
            'https://unpkg.com/pixi.js@7/dist/browser/pixi.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.2.4/pixi.min.js'
          ]);
        } else {
          console.log('âœ… PIXI å·²å­˜åœ¨');
        }
        
        // pixi-live2d-display (Cubism 4 version)
        if(!window.PIXI?.live2d){
          console.log('ðŸŽ­ åŠ è½½ pixi-live2d-display...');
          await tryLoad([
            '/web/lib/pixi-live2d-display.min.js',
            'https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.5.0-beta/dist/cubism4.min.js',
            'https://unpkg.com/pixi-live2d-display@0.5.0-beta/dist/cubism4.min.js'
          ]);
        } else {
          console.log('âœ… pixi-live2d-display å·²å­˜åœ¨');
        }
        
        console.log('ðŸŽ‰ ä¾èµ–åŠ è½½å®Œæˆ');
      }
      function ensurePixi() {
        const status = document.getElementById('status');
        if (!window.PIXI) {
          status.textContent = 'Ã— PIXI æœªåŠ è½½ï¼ˆå¯èƒ½æ˜¯ CDN è¢«æ‹¦æˆªï¼‰';
          throw new Error('PIXI not loaded');
        }
        if (!PIXI.live2d) {
          status.textContent = 'Ã— pixi-live2d-display æœªåŠ è½½ï¼ˆå¯èƒ½æ˜¯ CDN è¢«æ‹¦æˆªï¼‰';
          throw new Error('pixi-live2d-display not loaded');
        }
        if (!app) {
          app = new PIXI.Application({ backgroundAlpha: 0, resizeTo: document.getElementById('stage') });
          document.getElementById('stage').appendChild(app.view);
        }
      }

      async function findModelJson(dir){
        dir = dir.replace(/\\/g, '/');
        const base = dir.startsWith('/') ? dir : '/' + dir; // ç«™ç‚¹æ ¹è·¯å¾„è§£æž
        const segs = base.split('/').filter(Boolean);
        const dname = segs[segs.length - 1] || 'model';
        const candidates = [
          'model.model3.json',                 // å…¼å®¹å›ºå®šå‘½å
          `${dname}.model3.json`,              // ç›®å½•åç›¸åŒ
          'model3.json'                        // ç®€çŸ­å‘½å
        ];
        for(const n of candidates){
          try{
            const url = `${base}/${n}`;
            const r = await fetch(url, { method: 'HEAD' });
            if(r.ok) return url;
          }catch(e){}
        }
        // å…œåº•ï¼šè¿”å›žç¬¬ä¸€å€™é€‰
        return `${base}/model.model3.json`;
      }

      let currentModel = null;
      let currentMotions = {};
      // è§†å›¾å˜æ¢å‚æ•°
      let baseScale = 1;     // è‡ªé€‚åº”è®¡ç®—å¾—åˆ°çš„åŸºç¡€ç¼©æ”¾
      let userScale = 1;     // ç”¨æˆ·æ»šè½®é¢å¤–ç¼©æ”¾ç³»æ•°
      let panX = 0, panY = 0;// ç”¨æˆ·å¹³ç§»ï¼ˆåƒç´ ï¼‰
      let isDragging = false, lastX = 0, lastY = 0;

      function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

      function applyTransform(){
        if(!app || !currentModel) return;
        const vw = app.renderer.width;
        const vh = app.renderer.height;
        const s = baseScale * userScale;
        currentModel.scale.set(s);
        currentModel.position.set(vw * 0.5 + panX, vh * 0.95 + panY);
      }

      function fitModelToView() {
        if (!app || !currentModel) return;
        const vw = app.renderer.width;
        const vh = app.renderer.height;
        // ä¼˜å…ˆä½¿ç”¨æ¨¡åž‹å½“å‰çš„åƒç´ å°ºå¯¸
        let mw = currentModel.width || 0;
        let mh = currentModel.height || 0;
        // å…œåº•ï¼šä»Ž Cubism Core è¯»å–ç”»å¸ƒå°ºå¯¸
        if ((!mw || !mh) && currentModel.internalModel?.coreModel) {
          try {
            const core = currentModel.internalModel.coreModel;
            mw = (typeof core.getCanvasWidth === 'function') ? core.getCanvasWidth() : 2.0;
            mh = (typeof core.getCanvasHeight === 'function') ? core.getCanvasHeight() : 2.0;
          } catch(e) {}
        }
        // æœ€ç»ˆå…œåº•ï¼Œé¿å…é™¤0
        if (!mw || !mh) { mw = 1000; mh = 1200; }
        baseScale = Math.min(vw / mw, vh / mh) * 0.9; // ç•™10%è¾¹è·
        applyTransform();
      }
      async function load(){
        const dir = document.getElementById('modelDir').value.trim().replace(/\\\\/g,'/');
        const status = document.getElementById('status');
        status.textContent = 'åŠ è½½ä¸­â€¦';
        try{
          await ensureDeps();
          ensurePixi();
          const url = await findModelJson(dir);
          // pixi-live2d-display v3 ç”¨ Live2DModel.from() (Cubism 4)ï¼Œv0.4.0 å±žäºŽ Cubism 2 ç‰ˆæœ¬
          let mdl = null;
          if (PIXI.live2d?.Live2DModel) {
            mdl = await PIXI.live2d.Live2DModel.from(url);
          } else if (PIXI.live2d?.Live2DModelWebGL) {
            // æ—§ç‰ˆ APIï¼ˆå…œåº•ï¼Œä¸ä¿è¯å…¼å®¹ model3.jsonï¼‰
            throw new Error('å½“å‰ pixi-live2d-display ç‰ˆæœ¬ä¸æ”¯æŒ Cubism 4 model3.jsonã€‚è¯·ä½¿ç”¨ CDN å¯ç”¨çš„ v3 ç‰ˆæœ¬æˆ–æ”¹ç”¨ Web SDKã€‚');
          } else {
            throw new Error('pixi-live2d-display æœªæä¾›å¯ç”¨çš„ Live2DModel æŽ¥å£');
          }
          // è¯»å– model3.json ä»¥å‘çŽ°åŠ¨ä½œåˆ†ç»„
          const res = await fetch(url);
          const json = await res.json();
          currentMotions = (json.FileReferences && json.FileReferences.Motions) || {};
          app.stage.removeChildren();
          app.stage.addChild(mdl);
          mdl.anchor.set(0.5, 1.0);
          currentModel = mdl;
          fitModelToView();
          // è‹¥æ¨¡åž‹å«æœ‰å¸ƒå±€ä¿¡æ¯ï¼ˆå¦‚ Canvas ä¿¡æ¯ã€å°ºå¯¸æ ¡æ­£ï¼‰ï¼Œå°è¯•åº”ç”¨é¢å¤–ç¼©æ”¾/åç§»
          try {
            const canvasInfo = json?.Canvas || json?.Meta?.Canvas || null;
            if (canvasInfo && typeof canvasInfo.Width === 'number' && typeof canvasInfo.Height === 'number') {
              // åŸºäºŽ Canvas å°ºå¯¸å†æ¬¡å¾®è°ƒï¼Œé¿å…åªæ˜¾ç¤ºå±€éƒ¨
              const vw = app.renderer.width, vh = app.renderer.height;
              baseScale = Math.min(vw / canvasInfo.Width, vh / canvasInfo.Height) * 0.9;
              applyTransform();
            }
          } catch(e) {}
          // ç›‘å¬çª—å£æˆ–å®¹å™¨å°ºå¯¸å˜åŒ–ï¼Œä¿æŒè‡ªé€‚åº”
          window.removeEventListener('resize', fitModelToView);
          window.addEventListener('resize', fitModelToView);
          try {
            const stageEl = document.getElementById('stage');
            if (window.ResizeObserver && stageEl) {
              if (window.__live2dStageObserver) window.__live2dStageObserver.disconnect();
              window.__live2dStageObserver = new ResizeObserver(()=>fitModelToView());
              window.__live2dStageObserver.observe(stageEl);
            }
          } catch(e) {}

          // äº¤äº’åªéœ€è®¾ç½®ä¸€æ¬¡
          setupInteractions();
          
          // å¡«å……åŠ¨ä½œä¸‹æ‹‰
          const motionSel = document.getElementById('motionSelect');
          motionSel.innerHTML = '';
          Object.entries(currentMotions).forEach(([group, list])=>{
            if(Array.isArray(list)){
              list.forEach(item=>{
                const opt = document.createElement('option');
                opt.value = JSON.stringify({group, name: (item.Name||'')});
                opt.textContent = `${group}:${item.Name||'(unnamed)'}`;
                motionSel.appendChild(opt);
              });
            }
          });
          status.textContent = 'âœ“';
        }catch(e){
          console.error(e);
          status.textContent = 'Ã— ' + (e && (e.stack||e.message) || e);
        }
      }
      document.getElementById('loadBtn').addEventListener('click', load);

      // äº¤äº’è®¾ç½®ï¼ˆæ»šè½®ç¼©æ”¾ã€WASD/æ–¹å‘é”®å¹³ç§»ã€æ‹–æ‹½å¹³ç§»ï¼‰
      function setupInteractions(){
        if(!app || window.__live2dInteractionsSetup) return;
        const canvas = app.view;
        // é¼ æ ‡æ»šè½®ç¼©æ”¾
        canvas.addEventListener('wheel', (e)=>{
          e.preventDefault();
          const factor = e.deltaY < 0 ? 1.1 : (1/1.1);
          userScale = clamp(userScale * factor, 0.2, 8);
          applyTransform();
        }, { passive: false });

        // æ‹–æ‹½å¹³ç§»
        canvas.addEventListener('mousedown', (e)=>{
          if(e.button !== 0 && e.button !== 1) return; // å·¦é”®æˆ–ä¸­é”®
          isDragging = true; lastX = e.clientX; lastY = e.clientY;
        });
        window.addEventListener('mousemove', (e)=>{
          if(!isDragging) return;
          const dx = e.clientX - lastX;
          const dy = e.clientY - lastY;
          lastX = e.clientX; lastY = e.clientY;
          panX += dx; panY += dy;
          applyTransform();
        });
        window.addEventListener('mouseup', ()=>{ isDragging = false; });
        canvas.addEventListener('mouseleave', ()=>{ isDragging = false; });

        // é”®ç›˜å¹³ç§»ä¸Žé‡ç½®
        window.addEventListener('keydown', (e)=>{
          const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
          if(tag === 'input' || tag === 'textarea' || tag === 'select') return;
          const step = e.shiftKey ? 50 : 20;
          let used = true;
          switch(e.key){
            case 'w': case 'ArrowUp':    panY -= step; break;
            case 's': case 'ArrowDown':  panY += step; break;
            case 'a': case 'ArrowLeft':  panX -= step; break;
            case 'd': case 'ArrowRight': panX += step; break;
            case '+': case '=':          userScale = clamp(userScale * 1.1, 0.2, 8); break;
            case '-': case '_':          userScale = clamp(userScale / 1.1, 0.2, 8); break;
            case '0': case 'r': case 'R':
              userScale = 1; panX = 0; panY = 0; fitModelToView(); break;
            default: used = false;
          }
          if(used){ e.preventDefault(); applyTransform(); }
        });

        window.__live2dInteractionsSetup = true;
      }

      // å‚æ•°æ»‘å—
      document.getElementById('angleX').addEventListener('input', (ev)=>{
        if(!currentModel) return;
        currentModel.internalModel.coreModel.setParameterValueById('ParamAngleX', parseFloat(ev.target.value));
      });
      document.getElementById('blink').addEventListener('input', (ev)=>{
        if(!currentModel) return;
        const v = parseFloat(ev.target.value);
        currentModel.internalModel.coreModel.setParameterValueById('ParamEyeLOpen', v);
        currentModel.internalModel.coreModel.setParameterValueById('ParamEyeROpen', v);
      });

      // ç®€å•è¡¨æƒ…åˆ‡æ¢ï¼ˆéœ€å­˜åœ¨åŒå expï¼‰
      document.getElementById('exprSmile').addEventListener('click', ()=>{
        if(!currentModel) return;
        try{ currentModel.motion('Expression', {name: 'auto_smile', fadeIn: 200, fadeOut: 200}); }catch(e){}
      });
      document.getElementById('exprNeutral').addEventListener('click', ()=>{
        if(!currentModel) return;
        try{ currentModel.motion('Expression', {name: 'mtn_ex_010.exp3.json', fadeIn: 200, fadeOut: 200}); }catch(e){}
      });

      // æ’­æ”¾æ‰€é€‰åŠ¨ä½œ
      document.getElementById('playMotion').addEventListener('click', ()=>{
        if(!currentModel) return;
        const motionSel = document.getElementById('motionSelect');
        if(!motionSel.value) return;
        try{
          const sel = JSON.parse(motionSel.value);
          currentModel.motion(sel.group, { name: sel.name, fadeIn: 200, fadeOut: 200 });
        }catch(e){}
      });
    </script>
  </body>
  </html>
